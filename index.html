<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WiFi P2P Turbo Share</title>
    <link rel="manifest" href="manifest.json">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/simple-peer/9.11.1/simplepeer.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/web-streams-polyfill@2.0.2/dist/polyfill.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/streamsaver@2.0.3/StreamSaver.min.js"></script>

    <style>
        body { font-family: sans-serif; background: #0b0e11; color: #e9edef; text-align: center; padding: 20px; }
        .card { background: #202c33; padding: 25px; border-radius: 20px; max-width: 400px; margin: auto; }
        .dot { height: 12px; width: 12px; background: #ef4444; border-radius: 50%; display: inline-block; }
        .online { background: #22c55e; box-shadow: 0 0 10px #22c55e; }
        button { background: #00a884; color: white; border: none; padding: 15px; border-radius: 10px; cursor: pointer; width: 100%; font-weight: bold; }
        button:disabled { background: #3b4a54; }
        #progress { display: none; margin-top: 20px; background: #3b4a54; border-radius: 10px; height: 10px; overflow: hidden; }
        #progressBar { background: #00a884; height: 100%; width: 0%; transition: width 0.1s; }
    </style>
</head>
<body>
    <div class="card">
        <h2>WiFi Turbo Share</h2>
        <div class="status-container">
            <div id="dot" class="dot"></div>
            <span id="statusTxt">Aguardando conex√£o...</span>
        </div>
        
        <input type="file" id="fileInput" style="display: none">
        <button onclick="document.getElementById('fileInput').click()">üìÅ Selecionar Arquivo</button>
        <br><br>
        <button id="sendBtn" onclick="enviar()" disabled>üöÄ Enviar para Celular</button>

        <div id="progress">
            <div id="progressBar"></div>
        </div>
        <div id="speed" style="margin-top: 10px; font-size: 0.8em;"></div>
    </div>

    <script>
        const socket = io(); // Se usar no PC. Se for GitHub, mude para o IP do PC.
        let peer;
        let writer;
        let startTime;

        socket.on('user-joined', id => conectar(id, true));
        socket.on('signal', data => {
            if (!peer) conectar(data.from, false);
            peer.signal(data.signal);
        });

        function conectar(targetId, initiator) {
            peer = new SimplePeer({ initiator, trickle: false });

            peer.on('signal', signal => socket.emit('signal', { to: targetId, signal }));

            peer.on('connect', () => {
                document.getElementById('dot').classList.add('online');
                document.getElementById('statusTxt').innerText = "Conectado P2P!";
                document.getElementById('sendBtn').disabled = false;
            });

            peer.on('data', data => {
                // L√≥gica de Recebimento em Alta Velocidade
                if (typeof data === 'string' && data.startsWith('meta:')) {
                    const meta = JSON.parse(data.split('meta:')[1]);
                    const fileStream = streamSaver.createWriteStream(meta.name, { size: meta.size });
                    writer = fileStream.getWriter();
                    if ('vibrate' in navigator) navigator.vibrate(200);
                    return;
                }

                if (data.byteLength === 0) { // Fim do arquivo
                    writer.close();
                    alert("Arquivo recebido com sucesso!");
                    return;
                }

                writer.write(new Uint8Array(data));
            });
        }

        async function enviar() {
            const file = document.getElementById('fileInput').files[0];
            if (!file || !peer) return;

            document.getElementById('progress').style.display = 'block';
            
            // Envia metadados
            peer.send('meta:' + JSON.stringify({ name: file.name, size: file.size }));

            const chunkSize = 128 * 1024; // Pacotes de 128KB (Mais r√°pido)
            const reader = file.stream().getReader();
            let offset = 0;

            while (true) {
                const { done, value } = await reader.read();
                if (done) {
                    peer.send(new Uint8Array(0)); // Sinaliza fim
                    break;
                }
                
                peer.send(value);
                offset += value.byteLength;
                document.getElementById('progressBar').style.width = (offset / file.size * 100) + '%';
            }
            
            alert("Envio finalizado!");
            document.getElementById('progress').style.display = 'none';
        }
    </script>
</body>
</html>
