<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AirDrop Ultra - ID e QR Code</title>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    
    <style>
        :root { --primary: #007bff; --success: #28a745; --bg: #f4f4f9; }
        body { font-family: sans-serif; padding: 20px; text-align: center; max-width: 500px; margin: auto; background: var(--bg); }
        .card { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); margin-bottom: 20px; }
        .id-box { font-size: 24px; font-weight: bold; color: var(--primary); margin: 10px 0; letter-spacing: 2px; }
        #qrcode { margin: 15px auto; display: flex; justify-content: center; }
        input[type="text"] { width: 80%; padding: 12px; border-radius: 8px; border: 1px solid #ccc; margin-bottom: 10px; text-align: center; }
        .btn-blue { background: var(--primary); color: white; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; width: 100%; font-weight: bold; }
        .drop-zone { border: 2px dashed #ccc; padding: 25px; cursor: pointer; border-radius: 12px; margin-bottom: 10px; }
        #p-container { display:none; background:#eee; border-radius:10px; overflow:hidden; margin: 10px 0; }
        #progress-bar { width:0%; height:20px; background:var(--primary); color:white; font-size:12px; line-height:20px; transition: 0.1s; }
        .preview-card { display: flex; align-items: center; background: #fff; border: 1px solid #eee; border-radius: 10px; padding: 10px; margin-top: 10px; text-align: left; }
    </style>
</head>
<body>

    <div class="card">
        <h3>Seu N√∫mero de Conex√£o</h3>
        <div id="my-id" class="id-box">Gerando...</div>
        <button class="btn-blue" style="width: auto; padding: 5px 15px;" onclick="copyId()">üìã Copiar N√∫mero</button>
        
        <div id="qrcode"></div>
        <small>Pe√ßa ao parceiro para digitar este n√∫mero</small>
    </div>

    <div class="card">
        <input type="text" id="remote-id" placeholder="Digite o n√∫mero do parceiro">
        <button class="btn-blue" onclick="connect()">üîó Conectar Agora</button>
    </div>

    <div id="transfer-area" class="card" style="display: none;">
        <div id="drop-zone" class="drop-zone" onclick="document.getElementById('file-input').click()">
            üìÅ Clique para selecionar arquivos
        </div>
        <input type="file" id="file-input" multiple style="display: none;" onchange="updatePreview()">
        
        <div id="p-container"><div id="progress-bar">0%</div></div>
        
        <button class="btn-blue" onclick="sendFile()">üöÄ Enviar Arquivo</button>
        
        <h4 style="text-align: left; margin-top: 20px;">üïí Hist√≥rico de Arquivos</h4>
        <div id="download-area"></div>
    </div>

    <script>
        const CHUNK_SIZE = 5 * 1024 * 1024; // 5MB
        const peer = new Peer();
        let conn;
        let receivedChunks = {};

        // Ao abrir, gera o ID e o QR Code
        peer.on('open', id => {
            document.getElementById('my-id').innerText = id;
            new QRCode(document.getElementById("qrcode"), {
                text: id,
                width: 128,
                height: 128
            });
        });

        peer.on('connection', c => setupConn(c));

        function connect() {
            const rId = document.getElementById('remote-id').value;
            if (rId) setupConn(peer.connect(rId));
        }

        function setupConn(c) {
            conn = c;
            conn.on('open', () => {
                document.getElementById('transfer-area').style.display = 'block';
                alert("Conectado com sucesso!");
            });
            conn.on('data', data => handleData(data));
        }

        function handleData(data) {
            if (data.type === 'CHUNK') {
                if (!receivedChunks[data.name]) receivedChunks[data.name] = [];
                receivedChunks[data.name].push(data.chunk);
                
                if (receivedChunks[data.name].length * CHUNK_SIZE >= data.total) {
                    const blob = new Blob(receivedChunks[data.name], { type: data.fileType });
                    const url = URL.createObjectURL(blob);
                    addToHistory(data.name, url, false);
                    delete receivedChunks[data.name];
                }
            }
        }

        function sendFile() {
            const files = document.getElementById('file-input').files;
            if (!files.length || !conn) return;

            Array.from(files).forEach(f => {
                let offset = 0;
                document.getElementById('p-container').style.display = 'block';

                const readNext = () => {
                    const slice = f.slice(offset, offset + CHUNK_SIZE);
                    const reader = new FileReader();
                    reader.onload = e => {
                        conn.send({
                            type: 'CHUNK',
                            chunk: e.target.result,
                            name: f.name,
                            fileType: f.type,
                            total: f.size
                        });
                        offset += CHUNK_SIZE;
                        const pct = Math.min(100, Math.round((offset / f.size) * 100));
                        document.getElementById('progress-bar').style.width = pct + '%';
                        document.getElementById('progress-bar').innerText = pct + '%';

                        if (offset < f.size) readNext();
                        else {
                            addToHistory(f.name, URL.createObjectURL(f), true);
                            setTimeout(() => { document.getElementById('p-container').style.display = 'none'; }, 2000);
                        }
                    };
                    reader.readAsArrayBuffer(slice);
                };
                readNext();
            });
        }

        function addToHistory(name, url, isSent) {
            const area = document.getElementById('download-area');
            const card = document.createElement('div');
            card.className = 'preview-card';
            card.innerHTML = `
                <div style="flex-grow:1">
                    <small>${isSent ? '‚¨ÜÔ∏è Enviado' : '‚¨áÔ∏è Recebido'}</small><br>
                    <strong>${name}</strong>
                </div>
                <a href="${url}" download="${name}" style="text-decoration:none; font-size:20px;">üíæ</a>
            `;
            area.prepend(card);
        }

        function copyId() {
            const id = document.getElementById('my-id').innerText;
            navigator.clipboard.writeText(id);
            alert("ID Copiado!");
        }

        function updatePreview() {
            const count = document.getElementById('file-input').files.length;
            document.getElementById('drop-zone').innerText = `${count} arquivo(s) selecionado(s)`;
        }
    </script>
</body>
</html>
